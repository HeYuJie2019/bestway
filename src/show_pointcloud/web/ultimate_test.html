<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæè°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        .result { background: #1e1e1e; color: #ddd; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        input { padding: 8px; width: 400px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç»ˆæè°ƒè¯•æµ‹è¯•</h1>
        
        <div>
            <label>APIåœ°å€: </label>
            <input type="text" id="apiUrl" value="http://127.0.0.1:9001/api/config">
            <button onclick="testFetch()">ä½¿ç”¨Fetchæµ‹è¯•</button>
            <button onclick="testXHR()">ä½¿ç”¨XMLHttpRequestæµ‹è¯•</button>
            <button onclick="testCurl()">æ˜¾ç¤ºcurlå‘½ä»¤</button>
        </div>
        
        <h3>æµ‹è¯•ç»“æœ:</h3>
        <div class="result" id="result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script>
        function log(message, isError = false) {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            result.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            result.scrollTop = result.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('result').innerHTML = '';
        }
        
        async function testFetch() {
            clearLog();
            const url = document.getElementById('apiUrl').value;
            
            log(`=== ä½¿ç”¨Fetch APIæµ‹è¯• ===`);
            log(`URL: ${url}`);
            log(`å¼€å§‹æµ‹è¯•...`);
            
            try {
                log('è°ƒç”¨ fetch()...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                log(`âœ… æ”¶åˆ°å“åº”!`);
                log(`çŠ¶æ€ç : ${response.status} ${response.statusText}`);
                log(`å“åº”ç±»å‹: ${response.type}`);
                log(`URL: ${response.url}`);
                
                // æ˜¾ç¤ºå“åº”å¤´
                log(`\nå“åº”å¤´:`);
                response.headers.forEach((value, key) => {
                    log(`  ${key}: ${value}`);
                });
                
                // è¯»å–å“åº”ä½“
                log(`\næ­£åœ¨è¯»å–å“åº”ä½“...`);
                const text = await response.text();
                log(`åŸå§‹å“åº”: ${text.substring(0, 500)}`);
                
                try {
                    const json = JSON.parse(text);
                    log(`JSONè§£ææˆåŠŸ: ${JSON.stringify(json, null, 2)}`);
                } catch (e) {
                    log(`JSONè§£æå¤±è´¥: ${e.message}`, true);
                }
                
            } catch (error) {
                log(`\nâŒ è¯·æ±‚å¤±è´¥!`, true);
                log(`é”™è¯¯ç±»å‹: ${error.name}`, true);
                log(`é”™è¯¯æ¶ˆæ¯: ${error.message}`, true);
                log(`é”™è¯¯å †æ ˆ:\n${error.stack}`, true);
                
                if (error.name === 'AbortError') {
                    log(`è¯·æ±‚è¶…æ—¶ (5ç§’)`, true);
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log(`\nå¯èƒ½çš„åŸå› :`, true);
                    log(`1. CORSç­–ç•¥é˜»æ­¢`, true);
                    log(`2. ç½‘ç»œè¿æ¥é—®é¢˜`, true);
                    log(`3. æœåŠ¡å™¨æœªå“åº”`, true);
                    log(`4. æ··åˆå†…å®¹é—®é¢˜ (http vs https)`, true);
                }
            }
        }
        
        function testXHR() {
            clearLog();
            const url = document.getElementById('apiUrl').value;
            
            log(`=== ä½¿ç”¨XMLHttpRequestæµ‹è¯• ===`);
            log(`URL: ${url}`);
            
            const xhr = new XMLHttpRequest();
            
            xhr.onreadystatechange = function() {
                log(`readyStateå˜åŒ–: ${xhr.readyState}`);
                
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    log(`\næœ€ç»ˆçŠ¶æ€: ${xhr.status}`);
                    
                    if (xhr.status === 0) {
                        log(`âŒ çŠ¶æ€ç ä¸º0 - å¯èƒ½æ˜¯CORSé”™è¯¯æˆ–ç½‘ç»œé”™è¯¯`, true);
                    } else if (xhr.status >= 200 && xhr.status < 300) {
                        log(`âœ… è¯·æ±‚æˆåŠŸ!`);
                        log(`å“åº”å¤´: ${xhr.getAllResponseHeaders()}`);
                        log(`å“åº”ä½“: ${xhr.responseText.substring(0, 500)}`);
                    } else {
                        log(`âŒ HTTPé”™è¯¯: ${xhr.status}`, true);
                    }
                }
            };
            
            xhr.onerror = function() {
                log(`âŒ xhr.onerror è§¦å‘ - ç½‘ç»œé”™è¯¯`, true);
            };
            
            xhr.ontimeout = function() {
                log(`âŒ xhr.ontimeout è§¦å‘ - è¯·æ±‚è¶…æ—¶`, true);
            };
            
            xhr.onload = function() {
                log(`âœ… xhr.onload è§¦å‘`);
            };
            
            try {
                log(`è°ƒç”¨ xhr.open()...`);
                xhr.open('GET', url, true);
                
                log(`è®¾ç½®è¯·æ±‚å¤´...`);
                xhr.setRequestHeader('Accept', 'application/json');
                
                log(`è°ƒç”¨ xhr.send()...`);
                xhr.timeout = 5000;
                xhr.send();
                
            } catch (error) {
                log(`âŒ XHRå¼‚å¸¸: ${error.message}`, true);
                log(`é”™è¯¯å †æ ˆ:\n${error.stack}`, true);
            }
        }
        
        function testCurl() {
            clearLog();
            const url = document.getElementById('apiUrl').value;
            
            log(`=== curlå‘½ä»¤æµ‹è¯• ===`);
            log(`\nåœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:`);
            log(`\ncurl -v -H "Origin: http://127.0.0.1:8002" "${url}"`);
            log(`\næˆ–è€…:`);
            log(`\ncurl -v -H "Accept: application/json" "${url}"`);
            log(`\næˆ–æµ‹è¯•CORSé¢„æ£€:`);
            log(`\ncurl -X OPTIONS -H "Origin: http://127.0.0.1:8002" -H "Access-Control-Request-Method: GET" -v "${url}"`);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        window.addEventListener('load', () => {
            log(`=== ç¯å¢ƒä¿¡æ¯ ===`);
            log(`User Agent: ${navigator.userAgent}`);
            log(`å½“å‰URL: ${window.location.href}`);
            log(`åè®®: ${window.location.protocol}`);
            log(`ä¸»æœº: ${window.location.host}`);
            log(`\nè‡ªåŠ¨æµ‹è¯•å°†åœ¨2ç§’åå¼€å§‹...`);
            
            setTimeout(() => {
                testFetch();
            }, 2000);
        });
    </script>
</body>
</html>
